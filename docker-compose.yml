services:
  opencode:
    image: ${DOCKER_IMAGE:-ghcr.io/haytham-ai-assistant/opencode-docker-web:latest}
    container_name: opencode_web_app
    extra_hosts:
      - "host.docker.internal:host-gateway"

    volumes:
      # Mount the project directory into /app for live reload
      - .:/app:z
      # Dedicated workspace folder
      - ./workspace:/workspace:z
      # OpenCode configuration directory
      - ./config:/opt/opencode/config:z
      # OpenCode settings directory
      - ./opencode:/root/.local/share/opencode:z
      # Read‑only Git config from the host (for git commands inside the container)
      - ~/.gitconfig:/root/.gitconfig:ro
      # Read‑only GitHub CLI config from the host (for gh authentication)
      - ~/.config/gh:/root/.config/gh:ro

    environment:
      # OpenCode API Keys
      OPENCODE_API_KEY: ${OPENCODE_API_KEY:-}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}

      # OpenCode Web Server Configuration
      OPENCODE_SERVER_USERNAME: ${OPENCODE_SERVER_USERNAME:-}
      OPENCODE_SERVER_PASSWORD: ${OPENCODE_SERVER_PASSWORD:-}
      OPENCODE_SERVER_PORT: ${OPENCODE_SERVER_PORT:-}
      OPENCODE_SERVER_HOSTNAME: ${OPENCODE_SERVER_HOSTNAME:-}
      OPENCODE_SERVER_MDNS: ${OPENCODE_SERVER_MDNS:-false}
      OPENCODE_SERVER_MDNS_DOMAIN: ${OPENCODE_SERVER_MDNS_DOMAIN:-}
      OPENCODE_SERVER_CORS: ${OPENCODE_SERVER_CORS:-}

    working_dir: /workspace
    stdin_open: true
    tty: true
    restart: unless-stopped
    # Port mapping for OpenCode web server
    # Default port is randomly assigned by OpenCode, but can be set via OPENCODE_SERVER_PORT
    ports:
      - "${OPENCODE_SERVER_HOST_PORT:-4096}:${OPENCODE_SERVER_PORT:-4096}"

    # Optional health‑check – useful when container exposes a HTTP endpoint.
    # healthcheck:
    #   test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
    #   interval: 30s
    #   timeout: 10s
    #   retries: 3
